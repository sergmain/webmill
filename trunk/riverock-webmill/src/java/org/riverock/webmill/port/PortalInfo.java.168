/**
 * $Id: PortalInfo.java.168,v 1.1 2004/02/12 18:03:47 serg_main Exp $
 */
package com.jsmithy.webmill.port;

import java.util.Hashtable;
import java.util.Locale;

import com.jsmithy.common.tools.MainTools;
import com.jsmithy.generic.db.DatabaseAdapter;
import com.jsmithy.webmill.config.WebmillConfig;
import com.jsmithy.webmill.core.GetSiteListSiteItem;
import com.jsmithy.webmill.core.GetSiteSupportLanguageWithIdSiteList;
import com.jsmithy.webmill.portal.menu.SiteMenu;
import com.jsmithy.webmill.schema.core.SiteListSiteItemType;
import com.jsmithy.webmill.schema.core.SiteSupportLanguageItemType;
import com.jsmithy.webmill.schema.core.SiteSupportLanguageListType;
import com.jsmithy.webmill.schema.site.SiteTemplate;
import com.jsmithy.webmill.site.SiteListSite;
import com.jsmithy.webmill.site.SiteTemplateList;
import com.jsmithy.webmill.site.SiteTemplateMember;

import org.apache.log4j.Logger;

public class PortalInfo
{
    private static Logger log = Logger.getLogger( "com.jsmithy.webmill.port.PortalInfo" );

    static
    {
        Class p = new PortalInfo().getClass();
        try
        {
            com.jsmithy.sql.cache.SqlStatement.registerRelateClass( p, new GetSiteListSiteItem().getClass());
            com.jsmithy.sql.cache.SqlStatement.registerRelateClass( p, new PortalXsltList().getClass());
            com.jsmithy.sql.cache.SqlStatement.registerRelateClass( p, new SiteTemplateList().getClass());
            com.jsmithy.sql.cache.SqlStatement.registerRelateClass( p, new SiteTemplateMember().getClass());
            com.jsmithy.sql.cache.SqlStatement.registerRelateClass( p, new GetSiteSupportLanguageWithIdSiteList().getClass());
        }
        catch (Exception exception)
        {
            log.error("Exception in ", exception);
        }
    }

    public SiteListSiteItemType siteItem = new SiteListSiteItemType();
    private String serverName = null;

    public Locale defaultLocale = null;
    public PortalXsltList xsltList = null;
    public SiteTemplateList templates = null;
    public SiteTemplateMember memberTemplates = null;
    public SiteMenu siteMenu = null;

    public SiteSupportLanguageListType supportLanguage = null;
    private Hashtable supportLanguageHash = null;

    private static Object syncDebug = new Object();

    public long getIdSupportLanguage( Locale locale )
    {
        if (log.isDebugEnabled())
        {
            log.debug("get idSupportLanguage for locale "+locale.toString());
            log.debug("supportLanguage "+supportLanguage);
        }

        if (supportLanguage==null)
            return -1;

        if (supportLanguageHash==null)
        {
            supportLanguageHash = new Hashtable(supportLanguage.getSiteSupportLanguageCount());
            for (int i=0;i<supportLanguage.getSiteSupportLanguageCount(); i++)
            {
                SiteSupportLanguageItemType item = supportLanguage.getSiteSupportLanguage(i);
                supportLanguageHash.put(item.getCustomLanguage(), item.getIdSiteSupportLanguage() );
            }
        }

        Object obj  = supportLanguageHash.get( locale.toString() );
        if (log.isDebugEnabled())
            log.debug("result object "+obj);

        if (obj==null)
            return -1;

        return ((Long)obj).longValue();
    }

    public SiteTemplate getMemberTemplate()
    {
        SiteTemplate st = null;

        if (log.isDebugEnabled())
            log.debug("Looking template for locale " + defaultLocale.toString());

        if (memberTemplates != null && memberTemplates.memberTemplate != null)
            st = (SiteTemplate) memberTemplates.memberTemplate.get(defaultLocale.toString());

        if (st != null)
            return st;

        if (log.isInfoEnabled())
            log.info("memberTemplate for Locale " + defaultLocale.toString() + " not initialized");

        return new SiteTemplate();
    }

    protected void finalize() throws Throwable
    {
        if (log.isDebugEnabled())
            log.debug("#15.09.01 finalize");

        defaultLocale = null;
        xsltList = null;
        templates = null;
        memberTemplates = null;

        super.finalize();
    }

    private static long lastReadData = 0;
    private final static long LENGTH_TIME_PERIOD = 30000;
    private static PortalInfo backupPortalInfo = null;
    private static Object syncObject = new Object();

    public synchronized static PortalInfo getInstance(DatabaseAdapter db_, String serverName)
        throws Exception
    {
        if (log.isDebugEnabled())
        {
            log.debug("#15.01.01 lastReadData: " + lastReadData + ", current " + System.currentTimeMillis());
            log.debug("#15.01.02 LENGTH_TIME_PERIOD " + LENGTH_TIME_PERIOD + ", status " +
                (((System.currentTimeMillis() - lastReadData) > LENGTH_TIME_PERIOD)
                || (backupPortalInfo == null))
            );
        }
        if (((System.currentTimeMillis() - lastReadData) > LENGTH_TIME_PERIOD)
            || (backupPortalInfo == null))
        {
            synchronized(syncObject)
            {
                if (((System.currentTimeMillis() - lastReadData) > LENGTH_TIME_PERIOD)
                        || (backupPortalInfo == null))
                {
                    if (log.isDebugEnabled())
                    {
                        log.debug("#15.01.03 reinit cached value ");
                        log.debug("#15.01.04 old value " + backupPortalInfo);
                    }

                    backupPortalInfo = null;
                    backupPortalInfo = new PortalInfo(db_, serverName);

                    if (log.isDebugEnabled())
                        log.debug("#15.01.05 new value " + backupPortalInfo);
                }
                else
                {
                    if (log.isDebugEnabled())
                        log.debug("Get from cache");
                }

                if (log.isDebugEnabled())
                    log.debug("#15.01.09 ret value " + backupPortalInfo);

                lastReadData = System.currentTimeMillis();
                return backupPortalInfo;
            }
        }
        lastReadData = System.currentTimeMillis();
        return backupPortalInfo;
    }

    private PortalInfo(DatabaseAdapter db_, String serverName_)
        throws Exception
    {
        this.defaultLocale = MainTools.getLocale(WebmillConfig.getMainLanguage());
        this.setServerName(serverName_);

        if (log.isDebugEnabled())
            log.debug("Get PortalInfo instance for host '"+serverName_+"'");

        Long idSite = SiteListSite.getIdSite(serverName_);

        if (log.isDebugEnabled())
            log.debug("idSite for host - "+idSite);

        siteItem = GetSiteListSiteItem.getInstance( db_, idSite ).item;

        if (siteItem.getDefLanguage()==null)
            siteItem.setDefLanguage("");

        if (siteItem.getDefLanguage()!= null && siteItem.getDefLanguage().length()>0 &&
            siteItem.getDefCountry() != null && siteItem.getDefCountry().length()>0 )
        {

            defaultLocale = new Locale(
                siteItem.getDefLanguage(),
                siteItem.getDefCountry(),
                siteItem.getDefVariant()==null?"":siteItem.getDefVariant()
            );

            if (log.isDebugEnabled())
                log.debug("Main language 1.1: " + defaultLocale.toString());

        }
        else
        {
            defaultLocale = MainTools.getLocale(WebmillConfig.getMainLanguage());
            if (log.isDebugEnabled())
            {
                log.debug("Language InitParam.getMainLanguage(): " + WebmillConfig.getMainLanguage());
                log.debug("Language locale: " + defaultLocale.toString());
            }
        }

        long mills = 0; // System.currentTimeMillis();

        if (log.isInfoEnabled())
            mills = System.currentTimeMillis();

        xsltList = PortalXsltList.getInstance(db_, siteItem.getIdSite());
        if (log.isInfoEnabled())
        {
            log.info("Init xsltList for  "
                + (System.currentTimeMillis() - mills) + " milliseconds");
        }

        if (log.isInfoEnabled())
            mills = System.currentTimeMillis();
        templates = SiteTemplateList.getInstance(db_, siteItem.getIdSite());
        if (log.isInfoEnabled())
        {
            log.info("Init templates for  "
                + (System.currentTimeMillis() - mills) + " milliseconds");
        }

        if (log.isInfoEnabled())
            mills = System.currentTimeMillis();

        memberTemplates = SiteTemplateMember.getInstance(db_, siteItem.getIdSite());
        if (log.isInfoEnabled())
        {
            log.info("init member templates for  "
                + (System.currentTimeMillis() - mills) + " milliseconds");
        }

//        if (log.isInfoEnabled())
//            mills = System.currentTimeMillis();
//
//        currencyList = CurrencyList.getInstance(db_, sites.getIdSite()).list;
//        if (log.isDebugEnabled())
//        {
//            synchronized(syncDebug)
//            {
//                try
//                {
//                    byte[] originByte = XmlTools.getXml( currencyList, null );
//                    MainTools.writeToFile(InitParam.getMillDebugDir()+"debug-custom-currency-type.xml", originByte);
//                }
//                catch(Exception e)
//                {
//                    log.error("error write debug information",e);
//                }
//            }
//        }
//
//        if (log.isInfoEnabled())
//        {
//            log.info("init currency list for "+(System.currentTimeMillis()-mills)+" milliseconds");
//        }
//
//
//        if (log.isInfoEnabled())
//            mills = System.currentTimeMillis();
//
//        supportLanguage = GetSiteSupportLanguageWithIdSiteList.getInstance(db_, sites.getIdSite()).item;
//        if (log.isInfoEnabled())
//        {
//            log.info("init currency list for "+(System.currentTimeMillis()-mills)+" milliseconds");
//        }

        if (log.isInfoEnabled())
            mills = System.currentTimeMillis();

        // Build menu
        siteMenu = SiteMenu.getInstance(db_, siteItem.getIdSite().longValue() );
        if (log.isInfoEnabled())
            log.info("init SiteMenu for "+(System.currentTimeMillis()-mills)+" milliseconds");

    }

    public PortalInfo(){}

// Кусок кода для принудительной переинициализации класса
    public static PortalInfo getInstance(DatabaseAdapter db_, java.lang.Long id_)
    {
        return new PortalInfo();
    }

    public void reinit()
    {
        lastReadData = 0;
    }

    public void terminate(java.lang.Long id_)
    {
        lastReadData = 0;
    }

    public String getServerName()
    {
        return serverName;
    }

    public void setServerName(String serverName)
    {
        this.serverName = serverName;
    }
}
